<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Resort Admin Dashboard</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

    <style>
      body {
        font-family: "Inter", sans-serif;
        background: linear-gradient(180deg, #e8c580 0%, #c5a07e 100%);
        color: #2b2b2b;
        min-height: 100vh;
        padding-top: 80px;
      }

      .navbar {
        background-color: #3d1203;
        position: fixed;
        top: 0;
        width: 100%;
        z-index: 700;
      }

      .navbar-brand {
        color: #e8c580;
        font-weight: 700;
        font-size: 1.5rem;
      }

      .overview-card {
        color: #fff;
        border: none;
        border-radius: 14px;
        padding: 1.5rem;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
      }

      .btn-custom {
        background-color: #ba3d03;
        color: #fff;
        border-radius: 10px;
        transition: 0.3s ease;
      }

      .btn-custom:hover {
        background-color: #e48523;
        color: #fff;
      }

      .spin {
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .calendar {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        text-align: center;
      }

      .calendar-container {
        min-height: 280px;
        display: flex;
        flex-direction: column;
        justify-content: start;
      }

      #alertList {
        min-height: 280px;
      }

      .calendar-header {
        text-align: center;
        margin-bottom: 1rem;
        font-weight: 700;
        color: #3d1203;
      }

      .calendar-day {
        background-color: #fff;
        border-radius: 50%;
        width: 38px;
        height: 38px;
        line-height: 38px;
        margin: auto;
        transition: 0.3s;
      }

      .calendar-day:hover {
        background-color: #c5a07e;
        color: #fff;
      }

      .calendar-day.booking {
        background-color: #e8c580;
        color: #3d2b1f;
        font-weight: bold;
      }

      .calendar-day.checkin {
        background-color: #ba3d03;
        color: #fff;
        font-weight: bold;
      }

      .legend {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-bottom: 1rem;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.9rem;
      }

      .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 50%;
      }

      .legend-color.gold {
        background-color: #e8c580;
        border: 1px solid #b88d2e;
      }

      .legend-color.mahogany {
        background-color: #ba3d03;
      }

      .alert-custom {
        background: #fffaf5;
        border-left: 6px solid #ba3d03;
        border-radius: 8px;
        padding: 0.8rem 1rem;
        margin-bottom: 0.8rem;
      }

      #alertList {
        max-height: 350px;
        overflow-y: auto;
        padding-right: 8px;
      }

      #alertList::-webkit-scrollbar {
        width: 8px;
      }

      #alertList::-webkit-scrollbar-thumb {
        background-color: #ba3d03;
        border-radius: 10px;
      }

      #alertList::-webkit-scrollbar-track {
        background-color: #f0e7dd;
        border-radius: 10px;
      }

      .row.g-4.align-items-stretch {
        margin-bottom: 2rem;
      }

      .card {
        align-self: flex-start;
      }

      @media (max-width: 768px) {
        .row.g-4.align-items-stretch {
          margin-bottom: 1.5rem;
        }
      }
    </style>
  </head>

  <body>
    <nav class="navbar navbar-expand-lg">
      <div class="container">
        <a class="navbar-brand" href="#">üèñÔ∏è Resort Admin</a>
      </div>
    </nav>

    <div class="container mt-4">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
        <div class="d-flex align-items-center gap-1">
          <img id="adminPhoto" src="" alt="Admin Photo" class="rounded-circle border border-2 border-light shadow-sm" style="width: 60px; height: 50px; object-fit: cover;">
          <div>
            <h2 id="adminName" class="fw-bold mb-0" style="color: #3d1203;">Admin Dashboard</h2>
            <p class="text-muted mb-0" style="font-size: 0.9rem;">Welcome back, <span id="adminGreeting">Admin</span>!</p>
          </div>
        </div>
        <div class="mt-1 mt-md-0 d-flex gap-2">
          <button class="btn btn-outline-dark" id="backBtn"><i class="bi bi-arrow-left"></i> Back</button>
          <button class="btn btn-custom" id="refreshBtn"><i class="bi bi-arrow-clockwise me-2"></i>Refresh Data</button>
        </div>
      </div>

      <div class="row g-4 mb-4">
        <div class="col-md-4">
          <div class="overview-card" style="background-color: #ba3d03;">
            <div class="d-flex justify-content-between align-items-center">
              <div><h6>Bookings Today</h6><h3 id="bookingsCount">‚Äî</h3></div>
              <i class="bi bi-calendar2-check fs-1 opacity-50"></i>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="overview-card" style="background-color: #e48523;">
            <div class="d-flex justify-content-between align-items-center">
              <div><h6>Total Revenue</h6><h3 id="revenueTotal">‚Äî</h3></div>
              <i class="bi bi-cash-coin fs-1 opacity-50"></i>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="overview-card" style="background-color: #e8c580; color: #3d2b1f;">
            <div class="d-flex justify-content-between align-items-center">
              <div><h6>Available Rooms</h6><h3 id="availableRooms">‚Äî</h3></div>
              <i class="bi bi-door-closed fs-1 opacity-50"></i>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-4 align-items-stretch">
        <div class="col-md-7 d-flex">
          <div class="card p-4 border-0 shadow-sm flex-fill h-100">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <h5 class="fw-bold mb-1" style="color: #ba3d03;">Calendar</h5>
                <p class="text-muted mb-0">Bookings and Check-ins</p>
              </div>
              <div class="d-flex gap-2">
                <select id="monthSelect" class="form-select form-select-sm" style="width: 110px;">
                  <option value="0">January</option>
                  <option value="1">February</option>
                  <option value="2">March</option>
                  <option value="3">April</option>
                  <option value="4">May</option>
                  <option value="5">June</option>
                  <option value="6">July</option>
                  <option value="7">August</option>
                  <option value="8">September</option>
                  <option value="9">October</option>
                  <option value="10">November</option>
                  <option value="11">December</option>
                </select>
                <select id="yearSelect" class="form-select form-select-sm" style="width: 90px;"></select>
                <button id="filterBtn" class="btn btn-sm btn-custom"><i class="bi bi-filter me-1"></i>Filter</button>
              </div>
            </div>

            <div class="legend">
              <div class="legend-item"><div class="legend-color gold"></div> Booking</div>
              <div class="legend-item"><div class="legend-color mahogany"></div> Check-in</div>
            </div>
            <div id="calendarContainer" class="calendar-container flex-grow-1"></div>
          </div>
        </div>

        <div class="col-md-5 d-flex">
          <div class="card p-4 border-0 shadow-sm flex-fill h-100">
            <h5 class="fw-bold mb-2" style="color: #ba3d03;">Alerts</h5>
            <p class="text-muted mb-3">Recent notifications</p>
            <div id="alertList" class="flex-grow-1 overflow-auto"></div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function renderCalendar(bookings = [], checkins = [], year, month) {
        const container = document.getElementById("calendarContainer");
        container.innerHTML = "";
        const today = new Date();
        year = year ?? today.getFullYear();
        month = month ?? today.getMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const monthName = new Date(year, month).toLocaleString("default", { month: "long" });
        const header = `<div class="calendar-header fs-5 mb-2">${monthName} ${year}</div>`;
        const grid = document.createElement("div");
        grid.className = "calendar";
        const weekdays = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        weekdays.forEach(day => {
          const el = document.createElement("div");
          el.classList.add("fw-bold");
          el.textContent = day;
          grid.appendChild(el);
        });
        for (let i = 0; i < firstDay; i++) grid.appendChild(document.createElement("div"));
        for (let d = 1; d <= daysInMonth; d++) {
          const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
          const el = document.createElement("div");
          el.className = "calendar-day";
          if (bookings.includes(dateStr)) el.classList.add("booking");
          if (checkins.includes(dateStr)) el.classList.add("checkin");
          el.textContent = d;
          grid.appendChild(el);
        }
        container.innerHTML = header;
        container.appendChild(grid);
      }

      const yearSelect = document.getElementById("yearSelect");
      const currentYear = new Date().getFullYear();
      for (let y = currentYear - 3; y <= currentYear + 3; y++) {
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y;
        if (y === currentYear) opt.selected = true;
        yearSelect.appendChild(opt);
      }

      document.getElementById("filterBtn").addEventListener("click", async () => {
        const selectedMonth = parseInt(document.getElementById("monthSelect").value);
        const selectedYear = parseInt(document.getElementById("yearSelect").value);
        const res = await fetch(`/api/dashboard-data?month=${selectedMonth + 1}&year=${selectedYear}`);
        const data = await res.json();
        renderCalendar(data.bookings || [], data.checkins || [], selectedYear, selectedMonth);
      });

      async function fetchDashboardData() {
        try {
          const res = await fetch("/api/dashboard-data");
          const data = await res.json();
          document.getElementById("bookingsCount").textContent = data.bookingsToday || "0";
          document.getElementById("revenueTotal").textContent = data.totalRevenue ? `‚Ç±${data.totalRevenue.toLocaleString()}` : "‚Ç±0";
          document.getElementById("availableRooms").textContent = data.availableRooms || "0";
          renderCalendar(data.bookings || [], data.checkins || []);
          const alertList = document.getElementById("alertList");
          alertList.innerHTML = "";
          if (data.alerts?.length) {
            data.alerts.forEach(a => {
              const div = document.createElement("div");
              div.className = "alert-custom";
              div.innerHTML = `<strong>${a.icon || "üîî"} ${a.title}:</strong> ${a.message}`;
              alertList.appendChild(div);
            });
          } else {
            alertList.innerHTML = '<div class="text-muted">No alerts at the moment.</div>';
          }
        } catch (error) {
          console.error("Error fetching dashboard data:", error);
        }
      }

      async function fetchAdminInfo() {
        try {
          const res = await fetch("/api/admin-info");
          const admin = await res.json();
          document.getElementById("adminName").textContent = admin.name;
          document.getElementById("adminGreeting").textContent = admin.name;
          document.getElementById("adminPhoto").src = admin.photoUrl;
        } catch (error) {
          console.error("Error fetching admin info:", error);
        }
      }

      document.getElementById("refreshBtn").addEventListener("click", async () => {
        const btn = document.getElementById("refreshBtn");
        btn.classList.add("disabled");
        btn.innerHTML = '<i class="bi bi-arrow-repeat spin me-2"></i>Refreshing...';
        await fetchDashboardData();
        setTimeout(() => {
          btn.classList.remove("disabled");
          btn.innerHTML = '<i class="bi bi-arrow-clockwise me-2"></i>Refresh Data';
        }, 1000);
      });

      document.getElementById("backBtn").addEventListener("click", () => window.history.back());

      fetchDashboardData();
      fetchAdminInfo();
    </script>
  </body>
</html>
